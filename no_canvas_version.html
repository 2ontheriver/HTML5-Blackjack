<!DOCTYPE html>
<html>
<head>
<script src="components/model.js"></script> 
<script>

function Interface(tableIn){ //View 
    this.table = tableIn;
	this.buttons = {
	'start' : this.createButton('Start'), 'deal' : this.createButton('Deal'), 'clear' : this.createButton('Clear'), 
	'yes' : this.createButton('Yes'), 'no' : this.createButton('No'), 
	'hit' : this.createButton('Hit'), 'stand' : this.createButton('Stand'), 
	'double' : this.createButton('Double'), 'split' : this.createButton('Split'), 
	'new_hand' : this.createButton('New Hand'), 're_bet' : this.createButton('Re-bet'), 
	're_bet_deal' : this.createButton('Re-bet & Deal'), 'reload_page' : this.createButton('Leave Table')
	};
	this.inputs = { 'name' : document.createElement("INPUT"), 'bet' : document.createElement("INPUT")};
    var _this = this //used instead of bind for accessing this object in the event functions
	
	//attach model listeners
    this.table.gameStarting.attach(function (){ _this.startGame(); });    
	this.table.dealingHand.attach(function (){ _this.dealGame(); });
	this.table.offerUserInsurance.attach(function (sender, msg){ _this.offerInsurance(msg); });
	this.table.insuranceClosed.attach(function (){ _this.closeInsurance(); });
	this.table.userCardDealt.attach(function (){ _this.updatePlayerHand(); });
	this.table.userShowOptions.attach(function (){ _this.showHandOptions(); });
	this.table.dealerCardDealt.attach(function (){ _this.updateDealerHand(); });
	this.table.userHandBust.attach(function (){ _this.playerBust(); });
	this.table.userHandStood.attach(function (){ _this.playerStand(); });
	this.table.userDoubled.attach(function (){ _this.playerDoubled(); });
	this.table.userSplit.attach(function (){ _this.playerSplit(); });
	this.table.showCompareHandsResult.attach(function (sender, msg){ _this.showHandResult(msg); });
	this.table.userMessage.attach(function (sender, msg){ _this.showMessage(msg); });
	this.table.gameEnding.attach(function (sender, msg){ _this.endGame(msg); });
	
	//attach listeners to html controls
    this.buttons.start.onclick = function(){ _this.buttons.start.event.notify(); };    
	this.buttons.deal.onclick = function(){ _this.buttons.deal.event.notify(); };  
	this.buttons.clear.onclick = function(){ _this.inputs.bet.value = ''; };  
	this.buttons.yes.onclick = function(){ _this.buttons.yes.event.notify(); };
	this.buttons.no.onclick = function(){ _this.buttons.no.event.notify(); };
	this.buttons.hit.onclick = function(){ _this.buttons.hit.event.notify(); };
	this.buttons.stand.onclick = function(){ _this.buttons.stand.event.notify(); };
	this.buttons.double.onclick = function(){ _this.buttons.double.event.notify(); };
	this.buttons.split.onclick = function(){ _this.buttons.split.event.notify(); };
	this.buttons.new_hand.onclick = function(){ _this.buttons.new_hand.event.notify(); };
	this.buttons.re_bet.onclick = function(){ _this.buttons.re_bet.event.notify(); };
	this.buttons.re_bet_deal.onclick = function(){ _this.buttons.re_bet_deal.event.notify(); };
	this.buttons.reload_page.onclick = function(){ _this.buttons.reload_page.event.notify(); };
}
Interface.prototype.prepareGame = function() {
    document.getElementById("buttons").appendChild(this.buttons.start);
    document.getElementById("input").appendChild(this.inputs.name);
	this.showMessage('Enter your name.');
}
Interface.prototype.startGame = function() {
    this.clearButtons();
    this.clearInput();
	document.getElementById('game_container').style.display = "none";
    document.getElementById('dealers_cards').innerHTML = '';
	document.getElementById('players_cards').innerHTML = '';
	document.getElementById('bet').innerHTML = '';
	document.getElementById('insurance_bet').innerHTML = '';
	document.getElementById("buttons").appendChild(this.buttons.deal);
	document.getElementById("buttons").appendChild(this.buttons.clear);
    document.getElementById("input").appendChild(this.inputs.bet);
	this.showMessage(this.table.user.name + ', enter an amount to bet.');
	document.getElementById('cashier_container').style.display = "block";
	document.getElementById('cashier').innerHTML = this.table.user.balance;
	document.getElementById("leave_button").appendChild(this.buttons.reload_page);
}
Interface.prototype.dealGame = function() {
    this.clearButtons();
    this.clearInput();
	document.getElementById('insurance_bet').innerHTML = '';
    document.getElementById('hand2').style.display = "none";
	document.getElementById('bet').innerHTML = "<strong>Bet:</strong> &pound;" + this.table.startingBet;
	document.getElementById('game_container').style.display = "block";
	document.getElementById('dealers_cards').innerHTML = this.table.dealer;
	document.getElementById('players_cards').innerHTML = this.table.user.hands[0];
	document.getElementById('cashier').innerHTML = this.table.user.balance;
	this.showMessage('');
};
Interface.prototype.offerInsurance = function(messageIn) {
	this.showMessage(messageIn);
	document.getElementById("buttons").appendChild(this.buttons.yes);
	document.getElementById("buttons").appendChild(this.buttons.no);
}
Interface.prototype.closeInsurance = function() {
    this.showMessage('');
    if(this.table.insuranceBet != 0) {
	    document.getElementById('insurance_bet').innerHTML = "<strong>Insurance Bet:</strong> &pound;" + this.table.insuranceBet;
		document.getElementById('cashier').innerHTML = this.table.user.balance;
	}
	//if(this.table.user.hasBJ()) this.showMessage('You have Blackjack!'); //should this be prompted by the model??
	//this.showHandOptions();
}
Interface.prototype.showHandOptions = function() {
    this.clearButtons();
	var handOptions = this.table.getHandOptions();
	if(handOptions){
		var buttonContainer = document.getElementById("buttons");
		for (var i = 0; i < handOptions.length; i++) {
			buttonContainer.appendChild(this.buttons[handOptions[i]]);
		}
	}
}
Interface.prototype.updatePlayerHand = function() { 
	document.getElementById('players_cards').innerHTML = this.table.user.hands[0];
	if(this.table.user.hands.length > 1) document.getElementById('players_cards2').innerHTML = this.table.user.hands[1];
	document.getElementById('cashier').innerHTML = this.table.user.balance;
}
Interface.prototype.updateDealerHand = function() {
    document.getElementById('dealers_cards').innerHTML = this.table.dealer;
}
Interface.prototype.playerBust = function() {
    //this.showMessage('Player Hand Bust.');
}
Interface.prototype.playerStand = function() {
    this.clearButtons();
	this.updatePlayerHand();
}
Interface.prototype.playerDoubled = function() {
	document.getElementById('cashier').innerHTML = this.table.user.balance;
}
Interface.prototype.playerSplit = function() {
	document.getElementById('players_cards').innerHTML = this.table.user.hands[0];
    document.getElementById('hand2').style.display = "block";
	document.getElementById('players_cards2').innerHTML = this.table.user.hands[1];
	document.getElementById('cashier').innerHTML = this.table.user.balance;
}
Interface.prototype.showHandResult = function(messageIn) {
    this.clearButtons();
    this.showMessage(messageIn);
	document.getElementById('cashier').innerHTML = this.table.user.balance;
	document.getElementById("buttons").appendChild(this.buttons.new_hand);
	document.getElementById("buttons").appendChild(this.buttons.re_bet);
	document.getElementById("buttons").appendChild(this.buttons.re_bet_deal);
}
Interface.prototype.endGame = function(messageIn) {
    this.clearButtons();
	document.getElementById('game_container').style.display = "none";
	document.getElementById('bet').innerHTML = '';
	document.getElementById('insurance_bet').innerHTML = '';
	this.showMessage(messageIn);
}
Interface.prototype.showMessage = function(messageIn) {
	document.getElementById('message').innerHTML = messageIn;	
}
Interface.prototype.clearButtons = function() { //remove any previous buttons that existed
    var myNode = document.getElementById("buttons");
    while (myNode.firstChild) { myNode.removeChild(myNode.firstChild); }
}
Interface.prototype.clearInput = function() { //remove any previous inputs that existed
    var myNode = document.getElementById("input");
	while (myNode.firstChild) { myNode.removeChild(myNode.firstChild); }
}
Interface.prototype.createButton = function(text) { //possibly button object in own right???
    	var btn = document.createElement("BUTTON");
        btn.appendChild(document.createTextNode(text)); 
	    btn.event = new Event(this);
		return btn;
}

function Controller(tableIn, interfaceIn){  //Controller
    this.table = tableIn;
    this.interface = interfaceIn;
	var _this = this;
	
    this.table.userBalanceChange.attach(function (){ _this.saveBalance(); });   //attach a model listeners for balanace change to update localStorage
	
	this.interface.buttons.start.event.attach(function () { _this.startGame(); });
	this.interface.buttons.deal.event.attach(function () { _this.dealGame(); });
	this.interface.buttons.yes.event.attach(function () { _this.processInsurance(true); });
	this.interface.buttons.no.event.attach(function () { _this.processInsurance(false); });
	this.interface.buttons.hit.event.attach(function () { _this.playerHit(); });
	this.interface.buttons.stand.event.attach(function () { _this.playerStand(); });
	this.interface.buttons.double.event.attach(function () { _this.playerDouble(); });
	this.interface.buttons.split.event.attach(function () { _this.playerSplit(); });
	this.interface.buttons.new_hand.event.attach(function () { _this.newHand(); });
	this.interface.buttons.re_bet.event.attach(function () { _this.reBet(); });
	this.interface.buttons.re_bet_deal.event.attach(function () { _this.reBetDeal(); });
	this.interface.buttons.reload_page.event.attach(function () { _this.reloadGame(); });
} 
Controller.prototype.saveBalance = function(){ 
    localStorage.balance = this.table.user.balance;
}
Controller.prototype.prepareGame = function(){ 
	if (localStorage.getItem("name") !== null) {
        this.table.startGame(localStorage.name,  parseFloat(localStorage.balance));
	} else 
	    interface.prepareGame();
}
Controller.prototype.startGame = function(){ 
    if(this.table.startGame(this.interface.inputs.name.value)){
	    localStorage.name = this.interface.inputs.name.value;
		this.saveBalance();
	} else{
	    this.interface.showMessage('Enter a name with 3 to 10 characters.');
	}
} 
Controller.prototype.dealGame = function(){ 
    var playerBet = Math.floor(this.interface.inputs.bet.value);
    if(this.table.placeBet(playerBet)) this.table.deal();
}
Controller.prototype.processInsurance = function(userTookInsurance){
    this.table.takeInsurance(userTookInsurance);
}
Controller.prototype.playerHit = function(){ 
    this.table.userHits();
}
Controller.prototype.playerStand = function(){ 
    this.table.userStands();
}
Controller.prototype.playerDouble = function(){ 
    this.table.userDoubles();
}
Controller.prototype.playerSplit = function(){ 
    this.table.userSplits();
}
Controller.prototype.newHand = function(){ 
    this.table.newHand(false);
    this.interface.inputs.bet.value = '';
}
Controller.prototype.reBet = function(){ 
    this.table.newHand(false);
    this.interface.inputs.bet.value = this.table.previousBet;
}
Controller.prototype.reBetDeal = function(){ 
    this.table.newHand(true);
}
Controller.prototype.reloadGame = function(){ 
    window.location.reload(false);
	localStorage.removeItem("name");
	localStorage.removeItem("balance");
}

function Event(sender) {
    this.sender = sender;
    this.listeners = [];
}
Event.prototype = {
    attach : function (listener) {
        this.listeners.push(listener);
    },
    notify : function (args) {
        var index;

        for (index = 0; index < this.listeners.length; index += 1) {
            this.listeners[index](this.sender, args);
        }
    }
};

window.onload = function() {
    var table = new Table();
    interface = new Interface(table);
    cntrl = new Controller(table, interface);
	cntrl.prepareGame(); //set the original interface state
};

</script>
</head>
<body>
<h1>Blackjack Game</h1>

<p id="player_bets"><span id="bet"> </span> <span id="insurance_bet"> </span></p>

<div id="input"> </div>

<div id="game_container" style="display: none;">
<p><strong>Dealers Hand:</strong> <span id="dealers_cards"> </span></p>
<p><strong>Players Hand:</strong> <span id="players_cards"> </span></p>
<p id="hand2" style="display: none;"><strong>Players Hand 2:</strong> <span id="players_cards2"> </span></p>
</div>

<p id="message"> </p>

<div id="buttons"> </div>

<p id="cashier_container" style="display: none;"><strong>Cashier:</strong> &pound;<span id="cashier"> </span></p>
<div id="leave_button"> </div>
</body>
</html>