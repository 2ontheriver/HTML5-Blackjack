<!DOCTYPE html>
<html>
<head></head>
<body>
<style>
body{
padding: 0;
margin: 0;
}
</style>
<canvas id="background_wood_rim" width="920" height="580" style="position: absolute; z-index: -1;"></canvas>
<canvas id="background" width="920" height="580" style="position: absolute; z-index: 0;">Your browser does not support the HTML5 canvas tag.</canvas>
<canvas id="cashier" width="920" height="580" style="position: absolute; z-index: 1"></canvas>
<canvas id="buttons" width="920" height="580" style="position: absolute; z-index: 2"></canvas>
<canvas id="leave_button" width="920" height="580" style="position: absolute; z-index: 2"></canvas>
<canvas id="input" width="920" height="580" style="position: absolute; z-index: 3"></canvas>
<canvas id="player_cards" width="920" height="580" style="position: absolute; z-index: 4"></canvas>
<canvas id="dealer_cards" width="920" height="580" style="position: absolute; z-index: 5"></canvas>
<canvas id="deck" width="920" height="580" style="position: absolute; z-index: 10"></canvas>
<canvas id="player_bet" width="920" height="580" style="position: absolute; z-index: 6"></canvas>
<canvas id="player_bet_2" width="920" height="580" style="position: absolute; z-index: 6"></canvas>
<canvas id="insurance_bet" width="920" height="580" style="position: absolute; z-index: 7"></canvas>
<canvas id="message" width="920" height="580" style="position: absolute; z-index: 8"></canvas>
<canvas id="hit_canvas" width="920" height="580" style="position: absolute; z-index: 100"></canvas>
<script src="components/functions.js"></script> 
<script src="components/model.js"></script> 
<script src="components/background.js"></script> 
<script>


var cashierCanvas = document.getElementById("cashier");
var cashierLayer = cashierCanvas.getContext("2d");
var dealerCardsCanvas = document.getElementById("dealer_cards");
var dealerCardsLayer = dealerCardsCanvas.getContext("2d");
var playerCardsCanvas = document.getElementById("player_cards");
var playerCardsLayer = playerCardsCanvas.getContext("2d");
var deckCanvas = document.getElementById("deck");
var deckLayer = deckCanvas.getContext("2d");
var messageCanvas = document.getElementById("message");
var messageLayer = messageCanvas.getContext("2d");
var buttonCanvas = document.getElementById("buttons");
var buttonLayer = buttonCanvas.getContext("2d");
var leaveButtonCanvas = document.getElementById("leave_button");
var leaveButtonLayer = leaveButtonCanvas.getContext("2d");
var hitCanvas = document.getElementById("hit_canvas");
var hitLayer = hitCanvas.getContext("2d");
var playerBetCanvas = document.getElementById("player_bet");
var playerBetLayer = playerBetCanvas.getContext("2d");
var playerBetCanvas2 = document.getElementById("player_bet_2");
var playerBetLayer2 = playerBetCanvas2.getContext("2d");
var insuranceBetCanvas = document.getElementById("insurance_bet");
var insuranceBetLayer = insuranceBetCanvas.getContext("2d");

var gameFont = "Arial";

function Interface(tableIn){ //View 
    this.table = tableIn;
	this.cardImages = [];
	this.lookup = {}; //creates an object referncing the cardImages array so they can be choosen by name
	this.unplacedBets = 0;
	this.cardDealTime = 1000;
	this.plyrMveCrd = { 'x' : 18, 'y' : -18};
	this.plyrDealCrdPos; //set in deal, so it is reset every hand
	this.dlrStrtCrdPos;  //set in deal, so it is reset every hand
	var sources = [];
	for(num = 0; num < 52; num++){
		sources.push(this.table.deck.cards[num].suit + '_' + this.table.deck.cards[num].value);    
	}		
	this.loadCardImages = function(callback) {
		var loadedImages = 0;
		var numImages = 0;
		for(var src in sources) { // get num of sources
			numImages++;
		}
		for(var src in sources) {
		    var source = 'images/cards/' + sources[src] + '.png'; 
			this.cardImages[src] = new Image();
		    this.cardImages[src].name = sources[src];
			this.lookup[this.cardImages[src].name] = this.cardImages[src];
			this.cardImages[src].onload = function() {
				if(++loadedImages >= numImages) {
					if(callback !== undefined) callback();
				}
			};
			this.cardImages[src].src = source;
		}
	}
	
    this.nameInput = document.createElement("INPUT");
	this.nameInput.id = "name_input";
	this.nameInput.maxLength  = 10;
	this.nameInput.startValue = "enter name";
	this.canvasLeft = hitCanvas.offsetLeft; //find the left start point of the canvas 
	this.canvasTop = hitCanvas.offsetTop; //find the top start point of the canvas 
	var btnHeigth = 50;
	var btnTop = 520;
    this.buttons = {
	'start' : { text : 'Take Seat', colour: '#ccffff', width: 140, height: btnHeigth, top: btnTop, left: 390, event : new Event(this) },
	'deal' : { text : 'Deal', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 340, event : new Event(this) },
	'clear' : { text : 'Clear', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 470, event : new Event(this) },
	'double' : { text : 'Double', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 210, event : new Event(this) },
	'hit' : { text : 'Hit', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 340, event : new Event(this) },
	'stand' : { text : 'Stand', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 470, event : new Event(this) },
	'split' : { text : 'Split', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 600, event : new Event(this) },
	'leave' : { text : 'Leave Table', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 10, event : new Event(this) },
	'yes' : { text : 'Yes', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 340, event : new Event(this) },
	'no' : { text : 'No', colour: '#ccffff', width: 120, height: btnHeigth, top: btnTop, left: 470, event : new Event(this) },
	'new_hand' : { text : 'New Hand', colour: '#ccffff', width: 170, height: btnHeigth, top: btnTop, left: 195, event : new Event(this) }, 
	're_bet' : { text : 'Re-Bet', colour: '#ccffff', width: 170, height: btnHeigth, top: btnTop, left: 375, event : new Event(this) }, 
	're_bet_deal' : { text : 'Re-Bet & Deal', colour: '#ccffff', width: 170, height: btnHeigth, top: btnTop, left: 555, event : new Event(this) }
	};
	this.chipWrapper = { chips : chips, event : new Event(this) };
	var _this = this;
	
	//attach model listeners
    this.table.gameStarting.attach(function (){ _this.startGame(); }); 
	this.table.dealingHand.attach(function (){ _this.dealGame(); }); 
	this.table.offerUserInsurance.attach(function (sender, msg){ _this.offerInsurance(msg); });
	this.table.insuranceClosed.attach(function (){ _this.closeInsurance(); });
	this.table.userCardDealt.attach(function (sender, args){ _this.updatePlayerHand(args); });
	this.table.userShowOptions.attach(function (){ _this.showHandOptions(); });
	this.table.dealerCardDealt.attach(function (sender, args){ _this.updateDealerHand(args); });
	this.table.userHandBust.attach(function (){ _this.playerBust(); });
	this.table.userHandStood.attach(function (){ _this.playerStand(); });
	this.table.userDoubled.attach(function (sender, args){ _this.playerDoubled(args); });
	this.table.userSplit.attach(function (){ _this.playerSplit(); });
	this.table.showCompareHandsResult.attach(function (sender, args){ _this.showHandResult(args); });
	this.table.userMessage.attach(function (sender, msg){ _this.showMessage(msg); });
	this.table.gameEnding.attach(function (sender, msg){ _this.endGame(msg); });	
	this.table.userBalanceChange.attach(function (){ _this.drawCashier(); });  
	this.table.settleInsurance.attach(function (sender, win){ _this.settleInsuranceBet(win); });   
	
	//attach listeners to areas of the hit canvas 
	this.startClicked = function(event){ 
		if(_this.isClickOnButton(event, _this.buttons.start)) _this.buttons.start.event.notify();
	}
	this.isClickOnButton = function(event, buttonIn){
		var x = event.pageX - this.canvasLeft,
		y = event.pageY - this.canvasTop;
		if(y > buttonIn.top && y < buttonIn.top + buttonIn.height && x > buttonIn.left && x < buttonIn.left + buttonIn.width) return true;
		return false;
	}
	this.leaveClicked = function(event){ 
		if(_this.isClickOnButton(event, _this.buttons.leave)) _this.buttons.leave.event.notify();
	}
	this.dealClicked = function(event){
	    if(_this.isClickOnButton(event, _this.buttons.deal)){
		 _this.buttons.deal.event.notify();
		 }
	    else if(_this.isClickOnButton(event, _this.buttons.clear)) _this.buttons.clear.event.notify();
	}
	this.insuranceAnswerClicked = function(event){
	    if(_this.isClickOnButton(event, _this.buttons.yes)) _this.buttons.yes.event.notify();
	    else if(_this.isClickOnButton(event, _this.buttons.no)) _this.buttons.no.event.notify();
	}
	this.optionButtonClicked = function(event){	
		var handOptions = _this.table.getHandOptions(); //get the current hand options to only check listeners for the current buttons
		if(handOptions){
			for (var i = 0; i < handOptions.length; i++) {
				if(_this.isClickOnButton(event, _this.buttons[handOptions[i]])) _this.buttons[handOptions[i]].event.notify();	
			}
		}
	}
	this.newHandOptionClicked = function(event){
	    if(_this.isClickOnButton(event, _this.buttons.new_hand)) _this.buttons.new_hand.event.notify();
	    else if(_this.isClickOnButton(event, _this.buttons.re_bet)) _this.buttons.re_bet.event.notify();
	    else if(_this.isClickOnButton(event, _this.buttons.re_bet_deal)) _this.buttons.re_bet_deal.event.notify();
	}
	this.chipClicked = function(event){ 
		var x = event.pageX - _this.canvasLeft,
		y = event.pageY - _this.canvasTop;
		_this.chipWrapper.chips.forEach(function(element) {
			var yDist = x - element.x;
			var xDist = y - element.y;
			var dist = Math.sqrt(yDist*yDist + xDist*xDist);
			if (dist < element.size) {
				_this.chipWrapper.event.notify(element.value);
			  //_this.table.placeBet(element.value); //this should notify the controller to invoke the change on the model
			}
		});
	}

	this.prepareGame = function() {
		var rect = c.getBoundingClientRect();
		this.nameInput.style.cssText = 'position:absolute; left:' + (390 + rect.left) + 'px; top: ' + (380 + rect.top) + 'px; z-index:100; width: 120px; height: 25px; line-height: 25px; font-size: 19px; padding: 0 10px; margin: 0; font-family: ' + gameFont + '; text-align: center;';
		document.body.appendChild(this.nameInput);
		this.nameInput.style.color = '#ccc'
		this.nameInput.value = "enter name";
		this.nameInput.onfocus = function() {
			_this.nameInput.value = "";
			_this.nameInput.style.color = 'black'
		}
		this.showMessage('Enter your name and click \'Take Seat\'.');
		this.renderButton(this.buttons.start);
		hitCanvas.addEventListener("click", this.startClicked);
		//attach the html listener here
		this.loadCardImages(function() {
			_this.drawCardFan();
		});
	}
	this.dealGame = function() {
		this.plyrDealCrdPos = [{ 'x' : 427, 'y' : 285}, {'x' : 507, 'y' : 295}, {'x' : 347, 'y' : 295}];
		this.dlrStrtCrdPos = { 'x' : 427, 'y' : 30}; 
		this.updateBettingBox();
		messageLayer.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
		buttonLayer.clearRect(0, 0, buttonCanvas.width, buttonCanvas.height);
		hitCanvas.removeEventListener("click", this.newHandOptionClicked);
		playerCardsLayer.clearRect(0, 0, playerCardsCanvas.width, playerCardsCanvas.height);
		dealerCardsLayer.clearRect(0, 0, dealerCardsCanvas.width, dealerCardsCanvas.height);
		playerCardsLayer.drawImage(this.lookup[this.table.user.hands[0].cards[0].getName()],this.plyrDealCrdPos[0].x,this.plyrDealCrdPos[0].y);
		dealerCardsLayer.drawImage(this.lookup[this.table.dealer.cards[0].getName()],this.dlrStrtCrdPos.x,this.dlrStrtCrdPos.y);
		this.plyrDealCrdPos[0].x += this.plyrMveCrd.x;
		this.plyrDealCrdPos[0].y += this.plyrMveCrd.y;
		playerCardsLayer.drawImage(this.lookup[this.table.user.hands[0].cards[1].getName()],this.plyrDealCrdPos[0].x,this.plyrDealCrdPos[0].y); 
	}
}
Interface.prototype.startGame = function() {
	this.updateBettingBox();
	if(this.cardImages.length < 1) this.loadCardImages(); //if the card images were not loaded in the prepareGame() method
	if(document.getElementById(this.nameInput.id) != null) document.body.removeChild(this.nameInput);
	deckLayer.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
	messageLayer.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
	buttonLayer.clearRect(0, 0, buttonCanvas.width, buttonCanvas.height);
	playerCardsLayer.clearRect(0, 0, playerCardsCanvas.width, playerCardsCanvas.height);
	dealerCardsLayer.clearRect(0, 0, dealerCardsCanvas.width, dealerCardsCanvas.height);
	this.showMessage(this.table.user.name + ' click on the chips, to add them to your bet.');
	this.renderButton(this.buttons.deal);
	this.renderButton(this.buttons.clear);
	this.drawLeaveTableButton();
	hitCanvas.removeEventListener("click", this.startClicked);
	hitCanvas.removeEventListener("click", this.newHandOptionClicked);
	hitCanvas.addEventListener("click", this.dealClicked);
	hitCanvas.addEventListener("click", this.chipClicked);
	hitCanvas.addEventListener("click", this.leaveClicked);
	this.drawCashier();
	this.drawDeck();
}
Interface.prototype.updateBettingBox = function(clear) {
    if(clear === undefined) clear = false
	playerBetLayer.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
	playerBetLayer2.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
	insuranceBetLayer.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
	if(clear || (this.unplacedBets == 0 && this.table.startingBet == 0)) return;
	this.drawChips(0); 
}
Interface.prototype.showHandResult = function(handResults) {
    buttonLayer.clearRect(0, 0, buttonCanvas.width, buttonCanvas.height);
    this.showMessage(handResults.message);
	this.renderButton(this.buttons.new_hand);
	this.renderButton(this.buttons.re_bet);
	this.renderButton(this.buttons.re_bet_deal);
	hitCanvas.addEventListener("click", this.newHandOptionClicked);
	hitCanvas.removeEventListener("click", this.optionButtonClicked);
	//deal with payouts
	if(handResults.handsInfo[0][0] == 1) playerBetLayer.clearRect(0, 0, playerBetCanvas.width, playerBetCanvas.height);
	if(this.table.user.hasSplit()){
		if(handResults.handsInfo[1][0] == 1) playerBetLayer2.clearRect(0, 0, playerBetCanvas.width, playerBetCanvas.height);
		if(handResults.handsInfo[0][0] == 2){
			this.drawChips(1, false, 1);
			if(handResults.handsInfo[0][1]) this.drawChips(1, true, 1);
		}
		if(handResults.handsInfo[1][0] == 2){
			this.drawChips(2, false, 1);
			if(handResults.handsInfo[1][1]) this.drawChips(2, true, 1);
		}
	} else {
		if(handResults.handsInfo[0][0] == 2){
			this.drawChips(0, false, 1);
			if(handResults.handsInfo[0][1]) this.drawChips(0, true, 1);
		} else if(handResults.handsInfo[0][0] == 3) this.drawChips(0, false, 1.5);
	}
	
}
//hand is either 0 (standard hand), 1 (split hand 1), 2 (split hand 2), doubled is bool
//winnings is either 0 for not using field, 1 for yes, and 1.5 if playerBJ and winnings paid at 1.5
Interface.prototype.drawChips = function(handNo, doubled, winnings) { 
	if(doubled === undefined) doubled = false;
	if(winnings === undefined) winnings = 0;
	var placedBet = false;
	var layer = playerBetLayer;
	if(this.table.user.hands[0].cards.length > 0) placedBet = true;
	var position;
	if(handNo === undefined) handNo = 0;
	if(handNo == 0) position = { 'x' : 460, 'y' : 400 };
	else if(handNo == 1) position = { 'x' : 540, 'y' : 405 };
	else if(handNo == 2){
		position = { 'x' : 380, 'y' : 405 };
		layer = playerBetLayer2;
	}
	if(doubled) position.y += 37;
	layer.save();
	if(winnings != 0) position.x -= 37;
	layer.translate(position.x, position.y); //set the start point for drawing chips in the betting box
	var bet = this.unplacedBets;
	if(placedBet) bet = this.table.startingBet
	else this.drawBetNote(this.unplacedBets); 
	if(winnings == 1.5) bet = (bet*winnings); 
	var chipsInBetBox = [];
	for(var num = 0; num < 4; num++){
	    chipsInBetBox[num] = Math.floor(bet/chips[num].value);
	    bet -= (chipsInBetBox[num]*chips[num].value);
	}
	var chipsDrawn = 0;
	for(var num = 0; num < 4; num++){
		for(var cNum = 0; cNum < chipsInBetBox[num]; cNum++){
			drawChip(layer, chips[num]);
			layer.translate(0, -3); //each time a chip is drawn move the drawing position 4px up
			chipsDrawn++; //keep a counter of all the chips drawn to reset the drawing position
		}
	}
	layer.restore();	
}
Interface.prototype.placeInsuranceBet = function(winnings) { //if winnigns == true then draw the chips to represent winning
	insuranceBetLayer.save();
	if(winnings === undefined) winnings = false;
	if(winnings) insuranceBetLayer.translate(423, 230); //set the start point for drawing chips in the insurance curve
	else insuranceBetLayer.translate(460, 230); //set the start point for drawing chips in the insurance curve
	var bet = this.table.insuranceBet;
	if(winnings) bet += this.table.insuranceBet; //double the amount if paying out
	var chipsInBetBox = [];
	chipsInBetBox[4] = (bet % 1 == 0.5 ? 1 : 0);
	for(var num = 0; num < 4; num++){
	    chipsInBetBox[num] = Math.floor(bet/chips[num].value);
	    bet -= (chipsInBetBox[num]*chips[num].value);
	}
	var chipsDrawn = 0;
	for(var num = 0; num < 5; num++){
		for(var cNum = 0; cNum < chipsInBetBox[num]; cNum++){
			insuranceBetLayer.fillStyle = chips[num].color;
			drawChip(insuranceBetLayer, chips[num]);
			insuranceBetLayer.translate(0, -3); //each time a chip is drawn move the drawing position 4px up
			chipsDrawn++; //keep a counter of all the chips drawn to reset the drawing position
		}
	}
	insuranceBetLayer.restore();
}
Interface.prototype.drawBetNote = function(betAmount) {
	var noteLength = 10+(betAmount.toString().length * 6);
    playerBetLayer.beginPath();
	playerBetLayer.fillStyle = '#ddd';
	playerBetLayer.strokeStyle = '#333';
	playerBetLayer.lineWidth = 1;
	playerBetLayer.rect(-40-(noteLength/2), -25, noteLength, 18);
	playerBetLayer.fill();
	playerBetLayer.stroke();
	playerBetLayer.font = "12px " + gameFont;
	playerBetLayer.fillStyle = '#222';
	playerBetLayer.textAlign = "center";
	playerBetLayer.textBaseline = 'middle';
	playerBetLayer.fillText(betAmount, -40, -15);
}
Interface.prototype.offerInsurance = function(messageIn) {
	hitCanvas.removeEventListener("click", this.dealClicked);
	hitCanvas.removeEventListener("click", this.chipClicked);
	this.showMessage(messageIn);
	this.renderButton(this.buttons.yes);
	this.renderButton(this.buttons.no);
	hitCanvas.addEventListener("click", this.insuranceAnswerClicked);
}
Interface.prototype.closeInsurance = function() {
	hitCanvas.removeEventListener("click", this.dealClicked);
	hitCanvas.removeEventListener("click", this.chipClicked);
	hitCanvas.removeEventListener("click", this.insuranceAnswerClicked);
    messageLayer.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
    if(this.table.insuranceBet != 0) {
	    this.placeInsuranceBet();
	}
}
Interface.prototype.showHandOptions = function() {	
    buttonLayer.clearRect(0, 0, buttonCanvas.width, buttonCanvas.height);
	var handOptions = this.table.getHandOptions();
	if(handOptions){
		for (var i = 0; i < handOptions.length; i++) {
			this.renderButton(this.buttons[handOptions[i]]);
		}	
		hitCanvas.addEventListener("click", this.optionButtonClicked);
	} else 
	    hitCanvas.removeEventListener("click", this.optionButtonClicked);
}
Interface.prototype.updatePlayerHand = function(args) {// args.card, args.handNo, args.cardNo, args.hasSplit, args.doubled - available properties
    var handPos;
	if(!args.hasSplit) handPos = this.plyrDealCrdPos[0];
	else if(args.handNo == 0) handPos = this.plyrDealCrdPos[1];
	else if(args.handNo == 1) handPos = this.plyrDealCrdPos[2];
	handPos.x += this.plyrMveCrd.x;
	handPos.y += this.plyrMveCrd.y;
	playerCardsLayer.save();
	playerCardsLayer.translate(handPos.x, handPos.y);
	var image = this.lookup[args.card.getName()];
	if(args.doubled){
	    playerCardsLayer.rotate(-90 * Math.PI/180);
		playerCardsLayer.drawImage(image, -(image.width), 0);
	}
	else 
	    playerCardsLayer.drawImage(image, 0, 0);
	playerCardsLayer.restore();
	
}
Interface.prototype.updateDealerHand = function(args) {
	var cardDealt = args.cardNo; 
	dealerCardsLayer.clearRect(0, 0, dealerCardsCanvas.width, dealerCardsCanvas.height);
	if(cardDealt % 2 == 1) this.dlrStrtCrdPos.x = 464+((cardDealt-1)/2)*70;
	else if(cardDealt % 2 == 0) this.dlrStrtCrdPos.x = 497+((cardDealt-2)/2)*70;
	for(var i = 0; i < this.table.dealer.cards.length; i++){
	    dealerCardsLayer.drawImage(this.lookup[this.table.dealer.cards[i].getName()],this.dlrStrtCrdPos.x-(i*70),this.dlrStrtCrdPos.y);
	}
}
Interface.prototype.playerBust = function() { //remove the chips for the current hand when bust
	var handNo = this.table.user.getCurrentHandNo();
	var layer = (handNo == 0 ? playerBetLayer : playerBetLayer2);
	layer.clearRect(0, 0, playerBetCanvas.width, playerBetCanvas.height);
}
Interface.prototype.playerStand = function() {
    buttonLayer.clearRect(0, 0, buttonCanvas.width, buttonCanvas.height);
	hitCanvas.removeEventListener("click", this.optionButtonClicked);
}
Interface.prototype.playerDoubled = function(args) {
    var handNo; //this will be set to either; 0 (standard hand), 1 (split hand 1, left hand), 2 (split hand 2, rigth hand)
	if(!args.hasSplit) handNo = 0;
	else if(args.handNo == 0) handNo = 1;
	else if(args.handNo == 1) handNo = 2;
    this.drawChips(handNo, true); 
}
Interface.prototype.playerSplit = function() {
	playerCardsLayer.clearRect(0, 0, playerCardsCanvas.width, playerCardsCanvas.height);
	playerCardsLayer.drawImage(this.lookup[this.table.user.hands[0].cards[0].getName()],this.plyrDealCrdPos[1].x,this.plyrDealCrdPos[1].y);
	playerCardsLayer.drawImage(this.lookup[this.table.user.hands[1].cards[0].getName()],this.plyrDealCrdPos[2].x,this.plyrDealCrdPos[2].y);
	this.plyrDealCrdPos[1].x += this.plyrMveCrd.x;
	this.plyrDealCrdPos[1].y += this.plyrMveCrd.y;
	playerCardsLayer.drawImage(this.lookup[this.table.user.hands[0].cards[1].getName()],this.plyrDealCrdPos[1].x,this.plyrDealCrdPos[1].y);
	playerBetLayer.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
	this.drawChips(1);
	this.drawChips(2); 
	if(this.table.insuranceBet > 0) this.placeInsuranceBet(); //if there was an insurance bet, then redraw that as it was removed above
}
Interface.prototype.settleInsuranceBet = function(win) {
	if(win){
		//draw an extra insurance bet to the left of the exisiting bet
		this.placeInsuranceBet(true);
	} else insuranceBetLayer.clearRect(0, 0, insuranceBetCanvas.width, insuranceBetCanvas.height);
}
Interface.prototype.endGame = function(messageIn) {
}
Interface.prototype.renderButton = function(button) {
	var borderWidth = 4.5;
	buttonLayer.fillStyle = "rgba(255, 255, 255, 1)";
	buttonLayer.strokeStyle = "#444";
	buttonLayer.lineWidth = 1;
	roundRect(buttonLayer, button.left, button.top, button.width, button.height, 10, true);
	var grd=buttonLayer.createLinearGradient(button.left+borderWidth,button.top+borderWidth,button.left+borderWidth,button.top+(button.height-borderWidth*2));
	grd.addColorStop(0,"#00005E");
	grd.addColorStop(1, "#0000D9");
	buttonLayer.fillStyle=grd;
	buttonLayer.strokeStyle = "#00004d";
	roundRect(buttonLayer, button.left+borderWidth, button.top+borderWidth, button.width-borderWidth*2,  button.height-borderWidth*2, 10, true);
	buttonLayer.save();
	buttonLayer.globalAlpha=0.5;
	var grd=buttonLayer.createLinearGradient(button.left+borderWidth,button.top+borderWidth,button.left+borderWidth,button.top+(button.height/2-borderWidth*2));
	grd.addColorStop(0,"#ccccff");
	grd.addColorStop(1, "#6666ff");
	buttonLayer.fillStyle=grd;
	roundRect(buttonLayer, button.left+borderWidth, button.top+borderWidth, button.width-borderWidth*2,  button.height/2-borderWidth, 10, true, false);
	buttonLayer.restore();
	buttonLayer.fillStyle='white';
	buttonLayer.textAlign = 'center';
	buttonLayer.textBaseline="middle"; 
	buttonLayer.font = "22px Arial";
	buttonLayer.fillText(button.text, button.left+(button.width/2), button.top+(button.height/2));
}
Interface.prototype.drawDeck = function(){ 
	backOfCard = new Image();
	backOfCard.src = 'images/cards/blue_back.png';
	backOfCard.onload = function(){
		var ang = -45*Math.PI/180;
		deckLayer.translate(845, 15);
		deckLayer.rotate(ang);
	    deckLayer.drawImage(backOfCard, 0, 0);
		deckLayer.rotate(-ang);
		deckLayer.translate(-845, -15);
	}
}
Interface.prototype.drawCardFan = function(){ 
	var ang;
	var cFRadius = 435;
    deckLayer.translate(460, -180);//set the center point for drawing the circles
	var degreeMove = 1.8; //degree of angle move since the last card
	var startDegree = 138.5; //degree to draw the first card at
	deckLayer.lineWidth = 1.5;
	deckLayer.strokeStyle = "#ccffcc";
	deckLayer.fillStyle = "#000";
	this.cardImages.reverse();
	for(var num = 0; num < 52; num++){
		ang = (num*degreeMove+startDegree) * Math.PI / 180;
		deckLayer.rotate(ang);
		deckLayer.translate(0, -cFRadius);
		deckLayer.rotate(Math.PI);
		deckLayer.drawImage(this.cardImages[num],0,0);
		deckLayer.rotate(-Math.PI);
		deckLayer.translate(0, cFRadius);
		deckLayer.rotate(-ang);
	}
    deckLayer.translate(-460, 180); //reset the start point for deckLayer
}
Interface.prototype.drawCashier = function(balanceIn){
    cashierLayer.clearRect(0, 0, cashierCanvas.width, cashierCanvas.height);
    cashierLayer.beginPath();
    cashierLayer.rect(770, 450, 140, 120);
	cashierLayer.lineWidth = 2;
	leaveButtonLayer.lineWidth = 1;
	cashierLayer.strokeStyle = '#444';
    cashierLayer.fillStyle = '#fff';
    cashierLayer.fill();
    cashierLayer.stroke();
    cashierLayer.fillStyle = '#B3A75D';
    cashierLayer.fillRect(774.5, 514.5, 131, 26);
	cashierLayer.textBaseline="middle"; 
	cashierLayer.textAlign = 'center';
	cashierLayer.font = "Bold 20px Arial";
    cashierLayer.fillRect(774.5, 454.5, 131, 26);
    cashierLayer.fillStyle = '#000';
	cashierLayer.fillText(this.table.user.balance.format(), 840, 555);
	cashierLayer.fillText(this.table.getTotalBet(), 840, 495);
	cashierLayer.fillStyle = '#fff';
	cashierLayer.font = "Bold 15px " + gameFont;
	cashierLayer.fillText('BETS', 840, 468);
	cashierLayer.fillText('CASHIER', 840, 528);
}
Interface.prototype.drawLeaveTableButton = function(balanceIn){ 
	var borderWidth = 4.5;
	var leaveButton = this.buttons.leave;
    leaveButtonLayer.rect(leaveButton.left, leaveButton.top, leaveButton.width, leaveButton.height);
	leaveButtonLayer.lineWidth = 1;
	leaveButtonLayer.strokeStyle = '#444';
    leaveButtonLayer.fillStyle = '#fff';
    leaveButtonLayer.stroke();
    leaveButtonLayer.fill();
    leaveButtonLayer.beginPath();
    leaveButtonLayer.fillStyle = '#B3A75D';
    leaveButtonLayer.fillRect(leaveButton.left+borderWidth, leaveButton.top+borderWidth, leaveButton.width-(borderWidth*2), leaveButton.height-(borderWidth*2));
    leaveButtonLayer.beginPath();
	leaveButtonLayer.save();
	leaveButtonLayer.strokeStyle = '#fff';
    leaveButtonLayer.fillStyle = '#fff';
	leaveButtonLayer.translate(25, 545);
	leaveButtonLayer.moveTo(0,0);
	leaveButtonLayer.lineTo(10,10);
	leaveButtonLayer.lineTo(10,2);
	leaveButtonLayer.lineTo(25,2);
	leaveButtonLayer.lineTo(25,-2);
	leaveButtonLayer.lineTo(10,-2);
	leaveButtonLayer.lineTo(10,-10);
	leaveButtonLayer.closePath();
    leaveButtonLayer.stroke();
    leaveButtonLayer.fill();
	leaveButtonLayer.restore();
    leaveButtonLayer.fillStyle = '#fff';
	leaveButtonLayer.textBaseline="middle"; 
	leaveButtonLayer.textAlign = 'center';
	leaveButtonLayer.font = "22px " + gameFont;
	leaveButtonLayer.fillText('Leave', 85, this.buttons.leave.top+(this.buttons.leave.height/2));
}
Interface.prototype.showMessage = function(messageIn) {
	messageLayer.clearRect(0, 0, messageCanvas.width, messageCanvas.height);
	var length = (messageIn.length * 7 + 40);	
	var startLeft = (messageCanvas.width-length)/2;
	var startTop = 484;
	messageLayer.beginPath();
	messageLayer.fillStyle = '#fff';
	messageLayer.strokeStyle = '#222';
	messageLayer.lineWidth = 1;
	messageLayer.rect(startLeft, startTop, length, 26);
	messageLayer.fill();
	messageLayer.stroke();
	messageLayer.font = "16px " + gameFont;
	messageLayer.fillStyle = '#222';
	messageLayer.textAlign = "center";
	messageLayer.textBaseline = 'middle';
	messageLayer.fillText(messageIn, messageCanvas.width/2, startTop+13); 
}

function Controller(tableIn, interfaceIn){  //Controller
    this.table = tableIn;
    this.interface = interfaceIn;
	var _this = this;
	this.table.userBalanceChange.attach(function (){ _this.saveBalance(); });   //attach a model listener for balance change to update localStorage
	this.interface.buttons.start.event.attach(function () { _this.startGame(); });
	this.interface.buttons.deal.event.attach(function () { _this.dealGame(); });
	this.interface.buttons.clear.event.attach(function () { _this.clearChips(); });
	this.interface.buttons.yes.event.attach(function () { _this.processInsurance(true); });
	this.interface.buttons.no.event.attach(function () { _this.processInsurance(false); });
	this.interface.buttons.hit.event.attach(function () { _this.playerHit(); });
	this.interface.buttons.stand.event.attach(function () { _this.playerStand(); });
	this.interface.buttons.double.event.attach(function () { _this.playerDouble(); });
	this.interface.buttons.split.event.attach(function () { _this.playerSplit(); });
	this.interface.buttons.new_hand.event.attach(function () { _this.newHand(); });
	this.interface.buttons.re_bet.event.attach(function () { _this.reBet(); });
	this.interface.buttons.re_bet_deal.event.attach(function () { _this.reBetDeal(); });
	this.interface.buttons.leave.event.attach(function () { _this.reloadGame(); });
	this.interface.chipWrapper.event.attach(function (sender, chipValue) { _this.playerClickedChip(chipValue); });
} 
Controller.prototype.saveBalance = function(){ 
    localStorage.name = this.table.user.name;
    localStorage.balance = this.table.user.balance;
}
Controller.prototype.prepareGame = function(){ 
	if (localStorage.getItem("name") !== null) {
        this.table.startGame(localStorage.name,  parseFloat(localStorage.balance));
	} else {
	    interface.prepareGame();
	}
}
Controller.prototype.startGame = function(){ 
	var userNameField = this.interface.nameInput;
    if(userNameField.value !=  userNameField.startValue && this.table.startGame(userNameField.value)){
	    localStorage.name = userNameField.value;
		this.saveBalance();
	} else this.interface.showMessage('Enter a name with 3 to 10 characters.');
} 
Controller.prototype.playerClickedChip = function(chipValue){ 
	var failMessage = '';
	if(this.table.user.balance < chipValue) failMessage = 'You do have enough in your cashier to place this bet.';
	else if(this.table.maxBet < (chipValue + this.interface.unplacedBets)) failMessage = 'The table limit is ' + this.table.maxBet + '.';
	if(failMessage == ''){
		//alert("adding chips " + chipValue + " Total: " + this.interface.unplacedBets);
		this.interface.unplacedBets += chipValue;
		this.interface.updateBettingBox(); //add to betBox
	}
	else this.table.userMessage.notify(failMessage);
}
Controller.prototype.dealGame = function(){ 
    if(this.interface.unplacedBets >= this.table.minBet){
	    this.table.placeBet(this.interface.unplacedBets);
		this.interface.unplacedBets = 0;
	    this.table.deal();
		//this.interface.updateBettingBox(); 
	} 
}
Controller.prototype.clearChips = function(){ 
	this.interface.unplacedBets = 0;
	this.interface.updateBettingBox(true); 
}
Controller.prototype.processInsurance = function(userTookInsurance){
    this.table.takeInsurance(userTookInsurance);
}
Controller.prototype.playerHit = function(){
    this.table.userHits();
}
Controller.prototype.playerStand = function(){ 
    this.table.userStands();
}
Controller.prototype.playerDouble = function(){ 
    this.table.userDoubles();
}
Controller.prototype.playerSplit = function(){ 
    this.table.userSplits();
}
Controller.prototype.newHand = function(){ 
    this.table.newHand(false);
}
Controller.prototype.reBet = function(){ 	
    this.table.newHand(false);
	this.interface.unplacedBets = this.table.previousBet;
	this.interface.updateBettingBox(false); 
}
Controller.prototype.reBetDeal = function(){ 
    this.table.newHand(true);
}
Controller.prototype.reloadGame = function(){ 
    var leave = confirm("Are you sure you want to leave, all stats will be deleted");
	if (leave == true) {
		window.location.reload(false);
		localStorage.removeItem("name");
		localStorage.removeItem("balance");
	}
}

function Event(sender) {
    this.sender = sender;
    this.listeners = [];
}
Event.prototype = {
    attach : function (listener) {
        this.listeners.push(listener);
    },
    notify : function (args) {
        var index;

        for (index = 0; index < this.listeners.length; index += 1) {
            this.listeners[index](this.sender, args);
        }
    }
};

window.onload = function() {
    var table = new Table();
    interface = new Interface(table);
    cntrl = new Controller(table, interface);
	cntrl.prepareGame();
};

</script>
</body>
</html>